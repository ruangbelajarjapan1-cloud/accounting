<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RBMJ Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style> body{font-family:Inter,system-ui,Segoe UI,Arial} .card{border-radius:1rem; box-shadow:0 10px 20px rgba(0,0,0,.06)} </style>
</head>
<body class="bg-slate-50 text-slate-800">
<div class="max-w-6xl mx-auto p-4 md:p-8">
  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
    <h1 class="text-2xl md:text-3xl font-extrabold">RBMJ — Ruang Belajar Muslim Jepang</h1>
    <nav class="flex gap-2 flex-wrap">
      <button class="tab px-4 py-2 rounded-xl bg-white card" data-tab="attendance">Absensi</button>
      <button class="tab px-4 py-2 rounded-xl bg-white card" data-tab="spp">Pembayaran SPP</button>
      <button class="tab px-4 py-2 rounded-xl bg-white card" data-tab="invoice">Tagihan & PDF</button>
      <button class="tab px-4 py-2 rounded-xl bg-white card" data-tab="mukafaah">Mukafaah Guru</button>
      <button class="tab px-4 py-2 rounded-xl bg-white card" data-tab="expense">Pengeluaran</button>
      <button class="tab px-4 py-2 rounded-xl bg-white card" data-tab="cashbook">Buku Kas</button>
      <button class="tab px-4 py-2 rounded-xl bg-white card" data-tab="settings">Settings</button>
    </nav>
  </header>

  <section id="attendance" class="panel card bg-white p-4 md:p-6">
    <h2 class="text-xl font-bold mb-3">Absensi Kelas</h2>
    <div class="grid md:grid-cols-4 gap-3 items-end">
      <div><label class="text-sm">Kelas</label><select id="attClass" class="w-full border rounded-lg p-2"></select></div>
      <div><label class="text-sm">Siswa</label><select id="attStudent" class="w-full border rounded-lg p-2"></select></div>
      <div><label class="text-sm">Tanggal</label><input id="attDate" type="date" class="w-full border rounded-lg p-2"></div>
      <div><label class="text-sm">Status</label>
        <select id="attStatus" class="w-full border rounded-lg p-2">
          <option>Present</option><option>Absent</option><option>Late</option><option>Excused</option>
        </select>
      </div>
      <div class="md:col-span-4 flex gap-2">
        <input id="attNote" placeholder="Catatan (opsional)" class="flex-1 border rounded-lg p-2">
        <button id="btnMarkAtt" class="px-4 py-2 rounded-lg bg-sky-600 text-white">Simpan</button>
      </div>
    </div>
    <hr class="my-4">
    <div class="grid md:grid-cols-3 gap-3">
      <div><label class="text-sm">Filter Kelas</label><select id="attFilterClass" class="w-full border rounded-lg p-2"></select></div>
      <div><label class="text-sm">Bulan</label><input id="attFilterMonth" type="month" class="w-full border rounded-lg p-2"></div>
      <div class="flex items-end"><button id="btnLoadAtt" class="px-4 py-2 rounded-lg bg-slate-800 text-white w-full">Muat Rekap</button></div>
    </div>
    <div id="attTable" class="mt-4 overflow-auto"></div>
  </section>

  <section id="spp" class="panel card bg-white p-4 md:p-6 hidden">
    <h2 class="text-xl font-bold mb-3">Pembayaran SPP</h2>
    <div class="grid md:grid-cols-6 gap-3">
      <div class="md:col-span-2"><label class="text-sm">Siswa</label><select id="payStudent" class="w-full border rounded-lg p-2"></select></div>
      <div><label class="text-sm">Kelas</label><select id="payClass" class="w-full border rounded-lg p-2"></select></div>
      <div><label class="text-sm">Bulan</label><input id="payMonth" type="month" class="w-full border rounded-lg p-2"></div>
      <div><label class="text-sm">Jumlah (JPY)</label><input id="payAmount" type="number" class="w-full border rounded-lg p-2"></div>
      <div><label class="text-sm">Paket (bulan)</label><input id="payPkg" type="number" value="1" min="1" class="w-full border rounded-lg p-2"></div>
      <div class="md:col-span-6 flex gap-2">
        <input id="payNote" placeholder="Catatan" class="flex-1 border rounded-lg p-2">
        <button id="btnPay" class="px-4 py-2 rounded-lg bg-green-600 text-white">Catat Pembayaran</button>
      </div>
    </div>
  </section>

  <section id="invoice" class="panel card bg-white p-4 md:p-6 hidden">
    <h2 class="text-xl font-bold mb-3">Tagihan & PDF</h2>
    <div class="grid md:grid-cols-5 gap-3">
      <div class="md:col-span-2"><label class="text-sm">Siswa</label><select id="invStudent" class="w-full border rounded-lg p-2"></select></div>
      <div><label class="text-sm">Bulan</label><input id="invMonth" type="month" class="w-full border rounded-lg p-2"></div>
      <div class="flex items-end"><button id="btnCalcInv" class="w-full px-4 py-2 rounded-lg bg-slate-800 text-white">Hitung</button></div>
      <div class="flex items-end"><button id="btnGenInv" class="w-full px-4 py-2 rounded-lg bg-sky-600 text-white">Generate PDF</button></div>
    </div>
    <pre id="invResult" class="mt-4 bg-slate-100 p-3 rounded-lg text-xs overflow-auto"></pre>

    <hr class="my-6">
    <h3 class="font-bold mb-2">Rekap SPP Per Kelas (PDF)</h3>
    <div class="grid md:grid-cols-4 gap-3">
      <div><label class="text-sm">Kelas</label><select id="recapClass" class="w-full border rounded-lg p-2"></select></div>
      <div><label class="text-sm">Bulan</label><input id="recapMonth" type="month" class="w-full border rounded-lg p-2"></div>
      <div class="flex items-end"><button id="btnRecapPdf" class="w-full px-4 py-2 rounded-lg bg-sky-600 text-white">Export PDF</button></div>
    </div>
  </section>

  <section id="mukafaah" class="panel card bg-white p-4 md:p-6 hidden">
    <h2 class="text-xl font-bold mb-3">Mukafaah Guru</h2>
    <div class="grid md:grid-cols-5 gap-3">
      <div><label class="text-sm">Bulan</label><input id="mkMonth" type="month" class="w-full border rounded-lg p-2"></div>
      <div><label class="text-sm">Guru (opsional)</label><select id="mkTeacher" class="w-full border rounded-lg p-2"></select></div>
      <div class="flex items-end"><button id="btnCalcMk" class="w-full px-4 py-2 rounded-lg bg-slate-800 text-white">Hitung</button></div>
      <div class="flex items-end"><button id="btnMkPdf" class="w-full px-4 py-2 rounded-lg bg-sky-600 text-white">Export PDF</button></div>
    </div>
    <pre id="mkResult" class="mt-4 bg-slate-100 p-3 rounded-lg text-xs overflow-auto"></pre>
  </section>

  <section id="expense" class="panel card bg-white p-4 md:p-6 hidden">
    <h2 class="text-xl font-bold mb-3">Pengeluaran</h2>
    <div class="grid md:grid-cols-6 gap-3">
      <div><label class="text-sm">Tanggal</label><input id="exDate" type="date" class="w-full border rounded-lg p-2"></div>
      <div><label class="text-sm">Kategori</label><input id="exCat" class="w-full border rounded-lg p-2" placeholder="Sewa, Listrik, ..."></div>
      <div><label class="text-sm">Jumlah (JPY)</label><input id="exAmt" type="number" class="w-full border rounded-lg p-2"></div>
      <div class="md:col-span-3"><label class="text-sm">Deskripsi</label><input id="exDesc" class="w-full border rounded-lg p-2"></div>
      <div class="md:col-span-6 flex gap-2">
        <input id="exNote" placeholder="Catatan (opsional)" class="flex-1 border rounded-lg p-2">
        <button id="btnExAdd" class="px-4 py-2 rounded-lg bg-green-600 text-white">Simpan</button>
      </div>
    </div>
    <hr class="my-6">
    <h3 class="font-bold mb-2">Rekap & PDF</h3>
    <div class="grid md:grid-cols-3 gap-3">
      <div><label class="text-sm">Bulan</label><input id="exMonth" type="month" class="w-full border rounded-lg p-2"></div>
      <div class="flex items-end"><button id="btnExPdf" class="w-full px-4 py-2 rounded-lg bg-sky-600 text-white">Export PDF</button></div>
    </div>
  </section>

  <section id="cashbook" class="panel card bg-white p-4 md:p-6 hidden">
    <h2 class="text-xl font-bold mb-3">Buku Kas</h2>
    <div class="grid md:grid-cols-3 gap-3">
      <div><label class="text-sm">Bulan</label><input id="cbMonth" type="month" class="w-full border rounded-lg p-2"></div>
      <div class="flex items-end"><button id="btnCbLoad" class="w-full px-4 py-2 rounded-lg bg-slate-800 text-white">Hitung</button></div>
      <div class="flex items-end"><button id="btnCbPdf" class="w-full px-4 py-2 rounded-lg bg-sky-600 text-white">Export PDF</button></div>
    </div>
    <pre id="cbResult" class="mt-4 bg-slate-100 p-3 rounded-lg text-xs overflow-auto"></pre>
  </section>

  <section id="settings" class="panel card bg-white p-4 md:p-6 hidden">
    <h2 class="text-xl font-bold mb-3">Settings</h2>
    <div class="flex gap-2">
      <button id="btnMakeFolder" class="px-4 py-2 rounded-lg bg-sky-600 text-white">Buat Folder PDF</button>
      <span id="folderInfo" class="text-sm text-slate-500"></span>
    </div>
  </section>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbza6sbX4ROUBM-crFRaXTGYFkWxZ7baW0ePC5pRIlqfBAjz9f1gOao48zQtRxQqnbKUTQ/exec";

function api(action, data={}){
  return fetch(WEBAPP_URL+"?action="+encodeURIComponent(action), {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(Object.assign({action}, data))
  }).then(r=>r.json()).then(j=>{
    if(!j.ok) throw new Error(j.error||'API error'); return j.data;
  });
}

/* Tabs */
document.querySelectorAll('.tab').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.panel').forEach(p=>p.classList.add('hidden'));
    document.getElementById(b.dataset.tab).classList.remove('hidden');
  });
});

/* Populate selects */
async function init(){
  const [cls, std, tchs, cfg] = await Promise.all([
    api('listClasses'), api('listStudents'), api('listTeachers'), api('getConfig')
  ]);
  fillSelect('attClass', cls, 'id','class_name');
  fillSelect('attFilterClass', cls, 'id','class_name', true);
  fillSelect('payClass', cls, 'id','class_name');
  fillSelect('recapClass', cls, 'id','class_name');

  fillSelect('attStudent', std, 'id','full_name');
  fillSelect('payStudent', std, 'id','full_name');
  fillSelect('invStudent', std, 'id','full_name');

  fillSelect('mkTeacher', tchs, 'id','full_name', true);

  if (cfg && cfg.DRIVE_FOLDER_ID){
    document.getElementById('folderInfo').textContent = 'Folder PDF: ' + cfg.DRIVE_FOLDER_ID;
  }
}
function fillSelect(id, arr, valKey, textKey, addAll){
  const el = document.getElementById(id);
  el.innerHTML = '';
  if (addAll) el.append(new Option('— Semua —',''));
  arr.forEach(x=> el.append(new Option(x[textKey], x[valKey])));
}

/* Attendance */
document.getElementById('btnMarkAtt').onclick = async ()=>{
  const payload = {
    class_id: attClass.value, student_id: attStudent.value, date: attDate.value,
    status: attStatus.value, note: attNote.value
  };
  await api('markAttendance', payload);
  attNote.value='';
  alert('Absensi tersimpan.');
};

document.getElementById('btnLoadAtt').onclick = async ()=>{
  const data = await api('getAttendance', { class_id: attFilterClass.value, month: attFilterMonth.value });
  renderTable('attTable', data, ['date','class_id','student_id','status','note']);
};

/* Payments */
document.getElementById('btnPay').onclick = async ()=>{
  const payload = {
    student_id: payStudent.value, class_id: payClass.value, month: payMonth.value,
    amount_jpy: Number(payAmount.value||0), package_months: Number(payPkg.value||1),
    note: payNote.value
  };
  await api('recordPayment', payload);
  payNote.value=''; alert('Pembayaran dicatat.');
};

/* Invoice */
document.getElementById('btnCalcInv').onclick = async ()=>{
  const data = await api('calcInvoice', { student_id: invStudent.value, month: invMonth.value });
  invResult.textContent = JSON.stringify(data, null, 2);
};

document.getElementById('btnGenInv').onclick = async ()=>{
  const res = await api('generateInvoicePdf', { student_id: invStudent.value, month: invMonth.value });
  alert('PDF dibuat. Buka di Drive.\nFileId: '+res.fileId);
};

document.getElementById('btnRecapPdf').onclick = async ()=>{
  const res = await api('classSppRecapPdf', { class_id: recapClass.value, month: recapMonth.value });
  alert('PDF rekap kelas dibuat. FileId: '+res.fileId);
};

/* Mukafaah */
document.getElementById('btnCalcMk').onclick = async ()=>{
  const data = await api('calcMukafaah', { month: mkMonth.value, teacher_id: mkTeacher.value || null });
  mkResult.textContent = JSON.stringify(data, null, 2);
};
document.getElementById('btnMkPdf').onclick = async ()=>{
  const res = await api('mukafaahPdf', { month: mkMonth.value, teacher_id: mkTeacher.value || null });
  alert('PDF mukafaah dibuat. FileId: '+res.fileId);
};

/* Expenses */
document.getElementById('btnExAdd').onclick = async ()=>{
  await api('recordExpense', { date: exDate.value, category: exCat.value, amount_jpy: Number(exAmt.value||0), description: exDesc.value, note: exNote.value });
  exDesc.value=''; exNote.value='';
  alert('Pengeluaran dicatat.');
};
document.getElementById('btnExPdf').onclick = async ()=>{
  const res = await api('expensesReportPdf', { month: exMonth.value });
  alert('PDF pengeluaran dibuat. FileId: '+res.fileId);
};

/* Cashbook */
document.getElementById('btnCbLoad').onclick = async ()=>{
  const r = await api('cashbook', { month: cbMonth.value });
  cbResult.textContent = JSON.stringify(r, null, 2);
};
document.getElementById('btnCbPdf').onclick = async ()=>{
  const res = await api('cashbookPdf', { month: cbMonth.value });
  alert('PDF Buku Kas dibuat. FileId: '+res.fileId);
};

/* Settings */
document.getElementById('btnMakeFolder').onclick = async ()=>{
  const r = await api('createPdfFolder');
  folderInfo.textContent = 'Folder PDF: ' + r.folderId;
  alert('Folder PDF siap: '+r.folderId);
};

/* Utils */
function renderTable(elId, rows, cols){
  const el = document.getElementById(elId);
  if (!rows || rows.length===0){ el.innerHTML = '<div class="text-sm text-slate-500">Tidak ada data.</div>'; return; }
  const thead = '<thead><tr>'+ cols.map(c=>`<th class="px-3 py-2 text-left">${c}</th>`).join('') +'</tr></thead>';
  const tbody = '<tbody>'+ rows.map(r=>'<tr>'+ cols.map(c=>`<td class="px-3 py-2 border-t">${r[c]??''}</td>`).join('') +'</tr>').join('') +'</tbody>';
  el.innerHTML = `<table class="min-w-full text-sm">${thead}${tbody}</table>`;
}

init().catch(e=>alert(e.message));
</script>
</body>
</html>
