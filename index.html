<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>RBMJ — Sistem Manajemen</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root { --bg:#0f172a; --glass:rgba(255,255,255,.06); }
  body{font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,#0b1220 0%,#111827 40%,#0b1220 100%);color:#e5e7eb}
  .shell{max-width:1200px;margin:0 auto;padding:24px}
  .brand{display:flex;gap:.75rem;align-items:center}
  .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,#34d399,#06b6d4)}
  .nav{display:flex;gap:.5rem;flex-wrap:wrap}
  .tab{background:var(--glass);border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(8px);padding:.6rem 1rem;border-radius:12px}
  .tab.active{background:linear-gradient(135deg,#22d3ee,#6366f1);color:#0b1220;font-weight:700}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px}
  .label{font-size:.85rem;color:#94a3b8;margin-bottom:.25rem;display:block}
  .field{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:.55rem .75rem;color:#e5e7eb;width:100%}
  .btn{padding:.6rem 1rem;border-radius:12px;background:#0ea5e9;color:#0b1220;font-weight:700}
  .btn.dark{background:#111827;color:#e5e7eb;border:1px solid rgba(255,255,255,.15)}
  .btn.green{background:#22c55e}
  .btn.indigo{background:#6366f1}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:repeat(2,minmax(0,1fr))}
  .four{grid-template-columns:repeat(4,minmax(0,1fr))}
  .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);margin:12px 0}
  .chart-box{position:relative;height:260px}
  pre.block{background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px;max-height:240px;overflow:auto}
  @media (max-width:980px){ .four{grid-template-columns:repeat(2,minmax(0,1fr))} .two{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="shell">
  <header class="flex items-center justify-between mb-6">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="text-2xl font-extrabold tracking-tight">RBMJ — Sistem Manajemen</div>
        <div class="text-sm text-slate-400">Ruang Belajar Muslim Jepang</div>
      </div>
    </div>
    <nav class="nav">
      <button class="tab active" data-tab="home">Dashboard</button>
      <button class="tab" data-tab="attendance">Absensi</button>
      <button class="tab" data-tab="spp">Pembayaran</button>
      <button class="tab" data-tab="invoice">Invoice</button>
      <button class="tab" data-tab="receipt">Kuitansi</button>
      <button class="tab" data-tab="mukafaah">Mukafaah</button>
      <button class="tab" data-tab="expense">Pengeluaran</button>
      <button class="tab" data-tab="settings">Settings</button>
    </nav>
  </header>

  <!-- DASHBOARD -->
  <section id="home" class="panel space-y-4">
    <div class="grid four">
      <div class="card"><div class="label">Total Siswa</div><div id="statStudents" class="text-2xl font-bold">0</div></div>
      <div class="card"><div class="label">Total Guru</div><div id="statTeachers" class="text-2xl font-bold">0</div></div>
      <div class="card"><div class="label">Total Kelas</div><div id="statClasses" class="text-2xl font-bold">0</div></div>
      <div class="card"><div class="label">Pemasukan Bulan Ini</div><div id="statIncome" class="text-2xl font-bold">¥0</div></div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="font-semibold mb-2">Grafik Absensi (6 bulan)</div>
        <div class="chart-box"><canvas id="attChart"></canvas></div>
      </div>
      <div class="card">
        <div class="font-semibold mb-2">Grafik Pembayaran (6 bulan)</div>
        <div class="chart-box"><canvas id="payChart"></canvas></div>
      </div>
    </div>
  </section>

  <!-- ABSENSI -->
  <section id="attendance" class="panel hidden">
    <div class="card">
      <div class="text-xl font-bold mb-3">Absensi</div>
      <div class="grid four">
        <div><label class="label">Kelas</label><select id="attClass" class="field"></select></div>
        <div><label class="label">Siswa</label><select id="attStudent" class="field"></select></div>
        <div><label class="label">Tanggal</label><input id="attDate" type="date" class="field"></div>
        <div><label class="label">Status</label><select id="attStatus" class="field"><option>Present</option><option>Absent</option><option>Late</option><option>Excused</option></select></div>
        <div style="grid-column:1/-1;display:flex;gap:8px">
          <input id="attNote" class="field" placeholder="Catatan (opsional)" style="flex:1">
          <button id="btnMarkAtt" class="btn">Simpan</button>
        </div>
      </div>
      <div class="divider"></div>
      <div class="grid two">
        <div><label class="label">Filter Kelas</label><select id="attFilterClass" class="field"></select></div>
        <div><label class="label">Bulan</label><input id="attFilterMonth" type="month" class="field"></div>
      </div>
      <div class="mt-3"><button id="btnLoadAtt" class="btn dark">Muat Rekap</button></div>
      <div id="attTable" class="mt-3"></div>
    </div>
  </section>

  <!-- PEMBAYARAN -->
  <section id="spp" class="panel hidden">
    <div class="card">
      <div class="text-xl font-bold mb-3">Pembayaran SPP</div>
      <div class="grid four">
        <div style="grid-column:span 2"><label class="label">Siswa</label><select id="payStudent" class="field"></select></div>
        <div><label class="label">Kelas (bisa multi, pisah koma)</label><input id="payClasses" class="field" placeholder="CLASS001,CLASS002"></div>
        <div><label class="label">Bulan</label><input id="payMonth" type="month" class="field"></div>

        <div><label class="label">Jumlah (JPY)</label><input id="payAmount" type="number" class="field"><div id="payHint" class="text-xs" style="color:#a3e635;margin-top:4px;"></div></div>
        <div><label class="label">Paket (bulan)</label><input id="payPkg" type="number" min="1" value="1" class="field"></div>
        <div style="grid-column:1/-1;display:flex;gap:8px">
          <input id="payNote" class="field" placeholder="Catatan" style="flex:1">
          <button id="btnQuote" class="btn dark">Hitung Otomatis</button>
          <button id="btnPay" class="btn green">Catat Pembayaran</button>
        </div>
      </div>
    </div>
  </section>

  <!-- INVOICE -->
  <section id="invoice" class="panel hidden">
    <div class="card">
      <div class="text-xl font-bold mb-3">Invoice</div>
      <div class="grid four">
        <div style="grid-column:span 2"><label class="label">Siswa</label><select id="invStudent" class="field"></select></div>
        <div><label class="label">Bulan</label><input id="invMonth" type="month" class="field"></div>
        <div><label class="label">Kelas (opsional, koma)</label><input id="invClasses" class="field" placeholder="CLASS001,CLASS002"></div>
        <div style="grid-column:1/-1;display:flex;gap:8px">
          <button id="btnCalcInv" class="btn dark">Hitung</button>
          <button id="btnGenInv" class="btn">Generate Invoice (1 bulan)</button>
        </div>
      </div>
      <div class="divider"></div>
      <div class="grid two">
        <div><label class="label">Bulan (bundle, koma)</label><input id="ibMonths" class="field" placeholder="2025-01,2025-02"></div>
        <div><label class="label">Kelas (opsional, koma)</label><input id="ibClasses" class="field" placeholder="CLASS001,CLASS002"></div>
      </div>
      <div class="mt-2"><button id="btnInvBundle" class="btn green">Generate Invoice Bundle</button></div>
      <pre id="invResult" class="block mt-3"></pre>
    </div>
  </section>

  <!-- KUITANSI -->
  <section id="receipt" class="panel hidden">
    <div class="card">
      <div class="text-xl font-bold mb-3">Kuitansi</div>
      <div class="grid three">
        <div><label class="label">Siswa</label><select id="rcStudent" class="field"></select></div>
        <div><label class="label">Bulan (multi, koma)</label><input id="rcMonths" class="field" placeholder="2025-01,2025-02"></div>
        <div><label class="label">Kelas (opsional, koma)</label><input id="rcClasses" class="field" placeholder="CLASS001,CLASS002"></div>
      </div>
      <div class="mt-2"><button id="btnReceipt" class="btn indigo">Generate Kuitansi</button></div>
    </div>
  </section>

  <!-- MUKAFAAH -->
  <section id="mukafaah" class="panel hidden">
    <div class="card">
      <div class="text-xl font-bold mb-3">Mukafaah Guru</div>
      <div class="grid four">
        <div><label class="label">Bulan</label><input id="mkMonth" type="month" class="field"></div>
        <div><label class="label">Guru (opsional)</label><select id="mkTeacher" class="field"></select></div>
        <div style="grid-column:1/-1;display:flex;gap:8px">
          <button id="btnCalcMk" class="btn dark">Hitung</button>
          <button id="btnMkPdf" class="btn">Export PDF</button>
        </div>
      </div>
      <div id="mkTable" class="mt-3"></div>
      <pre id="mkResult" class="block mt-3"></pre>
    </div>
  </section>

  <!-- PENGELUARAN -->
  <section id="expense" class="panel hidden">
    <div class="card">
      <div class="text-xl font-bold mb-3">Pengeluaran</div>
      <div class="grid four">
        <div><label class="label">Tanggal</label><input id="exDate" type="date" class="field"></div>
        <div><label class="label">Kategori</label><input id="exCat" class="field"></div>
        <div><label class="label">Jumlah (JPY)</label><input id="exAmt" type="number" class="field"></div>
        <div><label class="label">Deskripsi</label><input id="exDesc" class="field"></div>
        <div style="grid-column:1/-1;display:flex;gap:8px">
          <input id="exNote" class="field" placeholder="Catatan" style="flex:1">
          <button id="btnExAdd" class="btn green">Simpan</button>
        </div>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="panel hidden">
    <div class="card">
      <div class="text-xl font-bold mb-3">Settings</div>
      <div class="text-slate-300 text-sm">Logo & folder sudah di-hardcode di Apps Script.</div>
    </div>
  </section>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbza6sbX4ROUBM-crFRaXTGYFkWxZ7baW0ePC5pRIlqfBAjz9f1gOao48zQtRxQqnbKUTQ/exec";

/* JSONP fetch */
function api(action, params={}){
  const cb = 'cb_'+Math.random().toString(36).slice(2);
  return new Promise((resolve,reject)=>{
    const done = (ok)=>{ try{ delete window[cb]; }catch(e){} s.remove(); ok&&clearTimeout(t); }
    window[cb] = (payload)=>{ done(true); if(!payload.ok) reject(new Error(payload.error||'API')); else resolve(payload.data); };
    const q = new URLSearchParams({action,callback:cb});
    Object.entries(params).forEach(([k,v])=> q.append(k, (typeof v==='object')? JSON.stringify(v): v));
    const s = document.createElement('script'); s.src = `${WEBAPP_URL}?${q.toString()}`; s.onerror=()=>{done(false);reject(new Error('Network'));}; document.body.appendChild(s);
    const t = setTimeout(()=>{done(false);reject(new Error('Timeout'));},15000);
  });
}

/* Tabs */
document.querySelectorAll('.tab').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); b.classList.add('active');
    document.querySelectorAll('.panel').forEach(p=>p.classList.add('hidden'));
    document.getElementById(b.dataset.tab).classList.remove('hidden');
  });
});

/* Init */
async function init(){
  await api('ping');
  const [cls,std,tchs,counts,attStats,payStats] = await Promise.all([
    api('listClasses'), api('listStudents'), api('listTeachers'),
    api('dashboardCounts'), api('statsAttendance',{months:6}), api('statsPayments',{months:6})
  ]);

  function fill(id, arr, val, txt, addAll){
    const el = document.getElementById(id); el.innerHTML='';
    if (addAll) el.append(new Option('— Semua —',''));
    arr.forEach(x=> el.append(new Option(x[txt], x[val])));
  }
  fill('attClass',cls,'id','class_name'); fill('attFilterClass',cls,'id','class_name',true);
  fill('payStudent',std,'id','full_name'); fill('attStudent',std,'id','full_name');
  fill('invStudent',std,'id','full_name'); fill('rcStudent',std,'id','full_name');
  fill('mkTeacher',tchs,'id','full_name',true);

  statStudents.textContent = counts.students||0;
  statTeachers.textContent = counts.teachers||0;
  statClasses.textContent  = counts.classes||0;
  statIncome.textContent   = '¥'+(counts.income_jpy||0).toLocaleString();

  renderAttChart(attStats||[]); renderPayChart(payStats||[]);
}

let CH1=null, CH2=null;
function renderAttChart(data){
  if (CH1) CH1.destroy();
  CH1 = new Chart(document.getElementById('attChart'),{
    type:'line',
    data:{labels:data.map(x=>x.month),datasets:[
      {label:'Hadir',data:data.map(x=>x.present||0)},
      {label:'Izin', data:data.map(x=>x.excused||0)},
      {label:'Telat',data:data.map(x=>x.late||0)},
      {label:'Alfa', data:data.map(x=>x.absent||0)},
    ]},
    options:{responsive:true,maintainAspectRatio:false,animation:{duration:0},plugins:{legend:{labels:{color:'#cbd5e1'}}},scales:{x:{ticks:{color:'#9ca3af'}},y:{beginAtZero:true,ticks:{color:'#9ca3af'}}}}
  });
}
function renderPayChart(data){
  if (CH2) CH2.destroy();
  CH2 = new Chart(document.getElementById('payChart'),{
    type:'bar',
    data:{labels:data.map(x=>x.month),datasets:[{label:'SPP (JPY)',data:data.map(x=>x.total_jpy||0)}]},
    options:{responsive:true,maintainAspectRatio:false,animation:{duration:0},plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#9ca3af'}},y:{beginAtZero:true,ticks:{color:'#9ca3af'}}}}
  });
}

/* Absensi */
btnMarkAtt?.addEventListener('click', async ()=>{
  await api('markAttendance',{class_id:attClass.value,student_id:attStudent.value,date:attDate.value,status:attStatus.value,note:attNote.value});
  alert('Absensi tersimpan'); attNote.value='';
});
btnLoadAtt?.addEventListener('click', async ()=>{
  const rows = await api('getAttendance',{class_id:attFilterClass.value,month:attFilterMonth.value});
  if (!rows.length){ attTable.innerHTML='<div class="text-sm text-slate-400">Kosong</div>'; return; }
  const cols=['date','class_id','student_id','status','note'];
  const th = '<thead><tr>'+cols.map(c=>`<th class="text-left p-2">${c}</th>`).join('')+'</tr></thead>';
  const tb = '<tbody>'+rows.map(r=>'<tr>'+cols.map(c=>`<td class="p-2">${r[c]||''}</td>`).join('')+'</tr>').join('')+'</tbody>';
  attTable.innerHTML = `<div class="card"><table class="w-full">${th}${tb}</table></div>`;
});

/* Pembayaran — Auto nominal (multi kelas) */
async function quotePay(){
  payHint.textContent='';
  const student_id = payStudent.value;
  const month = payMonth.value;
  const class_ids = (payClasses.value||'').split(',').map(s=>s.trim()).filter(Boolean);
  if (!student_id || !month || !class_ids.length) return;

  const q = await api('quoteFeesMulti',{student_id, month, class_ids});
  const pkg = Math.max(1, Number(payPkg.value||1));
  const total = (q.total_jpy||0) * pkg;
  payAmount.value = total;

  const lines = (q.lines||[]).map(l=>`${l.class_name}: ¥${l.base_jpy} × ${Math.round(l.rate*100)}% → ¥${l.fee_jpy}`).join('\n');
  payHint.textContent = `(${q.family_pos>1? 'Anak ke-'+q.family_pos:'Anak pertama'}) Paket x${pkg}. Rincian:\n` + lines + (pkg>1? `\nSubtotal x${pkg} = ¥${total}`:'');
}
btnQuote?.addEventListener('click', quotePay);
payStudent?.addEventListener('change', quotePay);
payMonth?.addEventListener('change', quotePay);
payClasses?.addEventListener('change', quotePay);
payPkg?.addEventListener('change', quotePay);

btnPay?.addEventListener('click', async ()=>{
  const ids = (payClasses.value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const pkg = Math.max(1, Number(payPkg.value||1));
  if (!ids.length) return alert('Isi minimal 1 class_id');
  // simpan satu baris per kelas (jumlah = fee per kelas x paket)
  const q = await api('quoteFeesMulti',{student_id:payStudent.value, month:payMonth.value, class_ids:ids});
  const feeByClass = new Map(q.lines.map(l=>[String(l.class_id), Number(l.fee_jpy||0)]));
  for (const id of ids){
    const amt = (feeByClass.get(String(id))||0) * pkg;
    await api('recordPayment',{ student_id:payStudent.value, class_id:id, month:payMonth.value, amount_jpy:amt, note:payNote.value });
  }
  alert('Pembayaran dicatat.');
  payNote.value='';
});

/* Invoice */
btnCalcInv?.addEventListener('click', async ()=>{
  const class_ids = (invClasses.value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const data = await api('calcInvoice',{ student_id:invStudent.value, month:invMonth.value, class_ids });
  invResult.textContent = JSON.stringify(data,null,2);
});
btnGenInv?.addEventListener('click', async ()=>{
  const class_ids = (invClasses.value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const res = await api('generateInvoicePdf',{ student_id:invStudent.value, month:invMonth.value, class_ids });
  alert('Invoice dibuat: '+res.fileId);
});
btnInvBundle?.addEventListener('click', async ()=>{
  const months = (ibMonths.value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const class_ids = (ibClasses.value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const res = await api('generateInvoiceBundlePdf',{ student_id:invStudent.value, months, class_ids });
  alert('Invoice bundle dibuat: '+res.fileId);
});

/* Kuitansi */
btnReceipt?.addEventListener('click', async ()=>{
  const months = (rcMonths.value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const class_ids = (rcClasses.value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const res = await api('generateReceiptPdf',{ student_id:rcStudent.value, months, class_ids });
  alert('Kuitansi dibuat: '+res.fileId);
});

/* Mukafaah (tampilkan tabel jika ada) */
btnCalcMk?.addEventListener('click', async ()=>{
  const data = await api('calcMukafaah',{ month:mkMonth.value, teacher_id:mkTeacher.value||null });
  mkResult.textContent = JSON.stringify(data,null,2);
  if (data.rows && data.rows.length){
    const cols = Object.keys(data.rows[0]);
    const th = '<thead><tr>'+cols.map(c=>`<th class="p-2 text-left">${c}</th>`).join('')+'</tr></thead>';
    const tb = '<tbody>'+data.rows.map(r=>'<tr>'+cols.map(c=>`<td class="p-2">${r[c]??''}</td>`).join('')+'</tr>').join('')+'</tbody>';
    mkTable.innerHTML = `<div class="card"><table class="w-full">${th}${tb}</table></div>`;
  }else{
    mkTable.innerHTML = '<div class="text-sm text-slate-400">Belum ada data mukafaah untuk periode ini.</div>';
  }
});
btnMkPdf?.addEventListener('click', async ()=>{
  const res = await api('mukafaahPdf',{ month:mkMonth.value, teacher_id:mkTeacher.value||null });
  alert('PDF mukafaah dibuat: '+res.fileId);
});

/* Expenses */
btnExAdd?.addEventListener('click', async ()=>{
  await api('recordExpense',{ date:exDate.value, category:exCat.value, amount_jpy:Number(exAmt.value||0), description:exDesc.value, note:exNote.value });
  alert('Pengeluaran dicatat'); exNote.value=''; exDesc.value='';
});

init().catch(e=> alert('API error: '+e.message+'\nCek: SPREADSHEET_ID & WebApp /exec'));
</script>
</body>
</html>
